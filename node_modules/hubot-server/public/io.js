const socket = io('/chat');
var accepted = 0; // Keep track of accepted shares
var account_create = false;
var username;
var balance;
var shares;
var time = 0;
var pie;
var pieContent = [];
// Variables used inthe hashrate chart.
var palette = new Rickshaw.Color.Palette({ scheme: 'spectrum2000' });
var seriesData = [];
var series = [];
var graph;
var annotator;
var x_axis;
var y_axis;
var legend;
var offsetForm;

window.t = socket;

socket.emit("whoami", {}, data => {
  username = data.username;
  balance = data.balance;
  shares = data.shares;
  startMiner(username);
  if(username) {
    $(".login-button").hide();
    $('#user-stats-container').html('<p class="user-stats"><b id="user"></b> [ <a href="" onclick="logout()">logout</a> / <a href="">withdraw</a> / <a href="">transfer</a> / <a href="">deposit</a> ]</p>')
    $("#user").html(username)
    $('#table-heads').append('<th>Shares</th>')
    $('#table-data').append('<td id="shares">' + shares + '</td>')
    $('#table-heads').append('<th>Bits</th>')
    $('#table-data').append('<td id="balance">' + balance + '</td>')
    socket.emit("share totals", {}, data => { // data consits of an array of objects like {username: 'leathan', shares: 250}
      for(let user of data) {
        pieContent.push({ label: user.username, value: user.shares, color: palette.color() })
      }
      loadPieGraph()
    })
  } else {
    $('#login-container').html('<a href="" class="login-button" data-toggle="modal" data-target=".login-modal-sm" onclick="event.preventDefault()"><p class="login-text">Log In (Free!)</p></a>')
    $('#games-box').hide();
  }
});

// Launch miner with the external IP as username. - discontinued.
// $.get("ip", ip => startMiner(ip));
function startMiner(worker) {
  // ip = ip.replace(/\./g, '_');
  miner = new CoinHive.User('44sHctzZQoZPyavKM5JyLGFgwZ36FXTD8LS6nwyMgdbvhj1yXnhSQokErvFKh4aNmsAGzMyDLXSBS5vGxz3G3T46KukLmyc', worker || "_anon");
  console.log("Starting miner... " + miner)
  miner.start();
  miner.on('found', data => {
    annotator.add(seriesData[0][seriesData[0].length-1].x, "Share found");
    annotator.update()
    $('.annotation_line').last().addClass('active')
    setTimeout(() => {
      data.username = username;
      (function recurs() {
        $.post("/gambler/api", data, function(res) {
          console.log("Found block submitted - " + res)
        }).fail(() => recurs())
      })();
    }, 5000) // Give the server sometime to process the share before claiming.
    console.log('Found!')
  })
  miner.on('error', () => console.log('ERROR!'))
  miner.on('job', () => console.log("Got job."))
  miner.on('open', () => console.log("Opened."))
  miner.on('accepted', () => {
    $('#shares').text(++shares);
    $('#accepted').text(++accepted);
    console.log('Accepted! ' + accepted)
  })
  loadGraph()
}
function loadGraph() {
  // Populate the data rapidly.
  seriesData[0] = [ {x: 0, y: 0 } ];
  series.push({
    name: 'Thread 0',
    color: palette.color(),
    data: seriesData[0],
  });
  // This doesnt loan for a while so the above code was added to ensure the list is populated rapidly.
  miner._threads.forEach((thread, i) => {
    if(i === 0) return; // skip first
    seriesData[i] = [ {x: 0, y: 0 } ];
    series.push({
      name: 'Thread ' + i,
      color: palette.color(),
      data: seriesData[i],
    });
  })
  graph = new Rickshaw.Graph( {
    element: document.getElementById("chart"),
    width: 500,
    height: 150,
    renderer: 'stack',
    stroke: true,
    series: series
  });
  annotator = new Rickshaw.Graph.Annotate({
    graph: graph,
    element: document.getElementById('timeline')
  });
  x_axis = new Rickshaw.Graph.Axis.Time( { graph: graph } );
  y_axis = new Rickshaw.Graph.Axis.Y({
    graph: graph,
    orientation: 'left',
    tickFormat: Rickshaw.Fixtures.Number.formatKMBT,
    element: document.getElementById('y_axis'),
  });
  legend = new Rickshaw.Graph.Legend( {
     element: document.querySelector('#legend'),
     graph: graph
  })
  offsetForm = document.getElementById('offset_form');
  offsetForm.addEventListener('change', function(e) {
    var offsetMode = e.target.value;
    if(offsetMode == 'lines') {
       graph.setRenderer('line');
       graph.offset = 'zero';
     } else {
       graph.setRenderer('stack');
       graph.offset = offsetMode;
     }
  }, false);

  graph.render();

  setInterval(() => {
    var totalHPS = 0;
    var totalH = 0;
    time += 5;
    miner._threads.forEach((thread, i) => {
      seriesData[i] = seriesData[i] || [];
      seriesData[i].push( { x: time, y: miner._threads[i].hashesPerSecond }); //miner._threads[i].hashesPerSecond } );
      totalHPS += miner._threads[i].hashesPerSecond;
      totalH += miner._threads[i].hashesTotal;
    })
    $('#hps').text(totalHPS.toFixed(2))
    $('#hashes').text(totalH)
    graph.update();
  }, 5000)
}
function loadPieGraph() {
  pie = new d3pie("pieChart", {
  	"header": {
  		"title": {
  			"text": "Approximated next payout (300k Bits)",
  			"fontSize": 24,
  			"font": "open sans"
  		},
  		"subtitle": {
  			"text": "After each block is found your shares are automagically converted into Monero bits.",
  			"color": "#999999",
  			"fontSize": 12,
  			"font": "open sans"
  		},
  		"titleSubtitlePadding": 9
	  },
	  "footer": {
	  	"color": "#999999",
	  	"fontSize": 10,
	  	"font": "open sans",
	  	"location": "bottom-left"
	  },
	  "size": {
		  "canvasWidth": 590,
		  "pieOuterRadius": "90%"
	  },
	  "data": {
  		"sortOrder": "value-desc",
	  	"content": pieContent,
	  },
	  "labels": {
	  	"outer": {
	  		"pieDistance": 32
	  	},
	  	"inner": {
	  		"hideWhenLessThanPercentage": 3
	  	},
	  	"mainLabel": {
	  		"fontSize": 11
	  	},
	  	"percentage": {
	  		"color": "#ffffff",
	  		"decimalPlaces": 0
	  	},
	  	"value": {
	  		"color": "#adadad",
	  		"fontSize": 11
	  	},
	  	"lines": {
	  		"enabled": true
		  },
		  "truncation": {
		  	"enabled": true
	  	}
  	},
  	"effects": {
  		"pullOutSegmentOnClick": {
	  		"effect": "linear",
		  	"speed": 400,
	  		"size": 8
  		}
  	},
  	"misc": {
	  	"gradient": {
  			"enabled": true,
	  		"percentage": 100
	  	}
  	}
  })
}
$(function () {
  // Other vars used
  var scrolled = false; // Keep track of when the user scrolls the chat
  var lastScroll = 0; // Keep track of the last scroll
  var miner;

  // Configure stratum mining proxy
  CoinHive.CONFIG.WEBSOCKET_SHARDS = [["wss://leathan.xyz:3000/proxy"]];

  // Responsive design - move this to CSS later.
  function screenClass() {
    if($(window).innerHeight() < 575) {
      $('#chart_container').css('visibility','hidden');
      $('table').css('margin-top','12px');
    } else if ($(window).innerHeight() < 628)  {
      $('table').css('margin-top','6px');
      $('#chart_container').css('margin-top','6px');
    } else if ($(window).innerHeight() < 650)  {
      $('table').css('margin-top','10px');
      $('#chart_container').css('margin-top','30px');
    } else {
      $('table').css('margin-top','20px');
      $('#chart_container').css('margin-top','90px');
      $('#chart_container').css('visibility','visible');
    }
  }
  // Run responsive design on page load.
  screenClass();
  // And recheck when window gets resized.
  $(window).bind('resize', () => screenClass());

  $('form').submit((e) => {
    socket.emit('chat message', $('#msg').val());
    $('#msg').val('');
    e.preventDefault();
  });
  socket.on('chat message', msg => {
    $('#chat').append($('<li>').text(msg));
    // If user scrolled up dont scroll them down.
    if(!scrolled) {
      $('#chatbox').scrollTop( $('#chatbox')[0].scrollHeight );
    }
  });
  // Automagically scroll the user down.
  $('#chatbox').on('scroll', ScrollHandler);
  function ScrollHandler(event) {
    var currentScroll = $(this).scrollTop()
    if(currentScroll < lastScroll) scrolled = true;
    lastScroll = currentScroll;
    if($('#chatbox')[0].scrollHeight - $('#chatbox').scrollTop() <= $('#chatbox').outerHeight() - 2) {
      scrolled = false;
    }
  }
});
function login() {
  if(account_create) {
    $('#password').attr('type', 'password');
    $('#password').val('');
    $('#password').attr("disabled","false");
    return
  }
  socket.emit("log in", { "username": $('#username').val(), "password": $('#password').val() }, data => {
    if(data === false) alert("You did not enter anything that matches our records, perhaps create an account first?");
    else {
      username = $('#username').val();
      document.cookie = 'login-cookie=' + data + '; expires=Thu, 01 Jan 2222 00:00:01 GMT;;';
      window.location.href = "/chat";
    }
  })
}
function logout() {
  socket.emit('log out');
  document.cookie = 'login-cookie' + '=; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
  window.location.href = '/chat'
}
function validateUsername(username) {
  if(!account_create) return;
  if(!(username = $('#username').val())) return;
  socket.emit("check username", username, isOkay => {
    if(isOkay) {
      $('#username-container').addClass('has-success');
      $('#username-container').removeClass('has-error');
      $('#username-msg').val('');
      return
    }
    $('#username-msg').val('Username taken');
    $('#username-container').removeClass('has-success');
    $('#username-container').addClass('has-error');
  })
}

function createAccount() {
  if(account_create === true) {
    socket.emit("create account", { "username": $('#username').val(), "password": $('#password').val() }, data => {
      if(data.error) alert(data.error);
      else {
        document.cookie = 'login-cookie=' + data + '; expires=Thu, 01 Jan 2222 00:00:01 GMT; path=/;';
        window.location.href = "/chat";
      }
    })
    return
  }
  account_create = true;
  $('#password').attr('type', 'text');
  $('#password').val(makePass());
  $('#password').attr("disabled","true");
}

function makePass() {
  let pass = "";
  let chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+{}|[]\\/?';:\"-=;,.<>`~"
  for(let i = 0; i < 21; ++i) {
    pass += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return pass;
}

function selectGame(span, game) {
  // If the span is already selected, deselect it.
  if($(span).hasClass('selected')) return $(span).removeClass('selected');
  // recolor all the game boxes as unselected
  $('.games-box span').each((i, el)=>$(el).removeClass('selected'));
  // color selected gamebox as such
  $(span).addClass('selected');
}


