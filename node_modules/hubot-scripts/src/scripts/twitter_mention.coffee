# Description:
#   Continuously searches Twitter for mentions of a specified string.
#
#   Requires a Twitter consumer key and secret, which you can get by 
#   creating an application here: https://dev.twitter.com/apps
#
# Commands:
#   mubot twitter search <search_term> - Set search query
#   mubot twitter search - Show current search query
#
# Dependencies:
#   oauth
#
# Configuration:
#   MUBOT_TWITTER_CONSUMER_KEY
#   MUBOT_TWITTER_CONSUMER_SECRET
#   MUBOT_TWITTER_MENTION_QUERY
#   MUBOT_TWITTER_MENTION_ROOM
#
# Author:
#   timdorr

oauth = require 'oauth'


twitter_bearer_token = null

module.exports = (bot) ->
  bot.brain.data.twitter_mention ?= {}

  key = process.env.MUBOT_TWITTER_CONSUMER_KEY
  secret = process.env.MUBOT_TWITTER_CONSUMER_SECRET
  if not key or not secret
    console.log "twitter_mention.coffee: MUBOT_TWITTER_CONSUMER_KEY and MUBOT_TWITTER_CONSUMER_SECRET are required. Get your tokens here: https://dev.twitter.com/apps"
    return

  twitterauth = new oauth.OAuth2(key, secret, "https://api.twitter.com/", null, "oauth2/token", null)

  twitterauth.getOAuthAccessToken "", {grant_type:"client_credentials"}, (e, access_token, refresh_token, results) ->
    twitter_bearer_token = access_token
    twitter_setup_search bot

  bot.respond /twitter search (.*)/i, (msg) ->
    bot.brain.data.twitter_mention.query = msg.match[1]
    bot.brain.data.twitter_mention.last_tweet = ""
    msg.send "Now searching Twitter for: #{twitter_query(bot)}"

  bot.respond /twitter search$/i, (msg) ->
    msg.send "Searching Twitter for: #{twitter_query(bot)}"


twitter_query = (bot) ->
  bot.brain.data.twitter_mention.query ||
    process.env.MUBOT_TWITTER_MENTION_QUERY


twitter_setup_search = (bot) ->
  if not twitter_bearer_token
    console.log "Invalid Twitter consumer key/secret!"
    return
  
  setInterval ->
    if twitter_query(bot)?
      twitter_search(bot)
  , 1000 * 60 * 1

  if twitter_query(bot)?
    twitter_search(bot)


twitter_search = (bot) ->
  last_tweet = bot.brain.data.twitter_mention.last_tweet || ''

  bot.http("https://api.twitter.com/1.1/search/tweets.json")
    .header("Authorization", "Bearer #{twitter_bearer_token}")
    .query(q: escape(twitter_query(bot)), since_id: last_tweet)
    .get() (err, response, body) ->
      tweets = JSON.parse(body)
      if tweets.statuses? and tweets.statuses.length > 0
        bot.brain.data.twitter_mention.last_tweet = tweets.statuses[0].id_str
        for tweet in tweets.statuses.reverse()
          message = "Tweet: #{tweet.text} - @#{tweet.user.screen_name} http://twitter.com/#{tweet.user.screen_name}/status/#{tweet.id_str}"
          bot.messageRoom process.env.MUBOT_TWITTER_MENTION_ROOM, message
