# Description: 
#   Teach Hubot to play nice with Ruby via rimubot (https://github.com/minton/rimubot)
#
# Dependencies:
#   None
#
# Configuration:
#   RMUBOT_PATH - Path to Rimubot
#   MUBOT_URL - URL to Hubot HTTP router - http://192.168.0.0:8080
#
# Commands:
#   rb <cmd> <args> - Runs a Ruby script named <cmd> sending the arguments <args>.
#
# Author:
#   @mcminton

sh = require('sh')
scriptPath = process.env.RMUBOT_SCRIPT_PATH
routerPost = "/imubot/rimubot"
httpUrl = process.env.MUBOT_URL + routerPost

module.exports = (bot) ->
  bot.hear /rb\s{1}([^\s]+)\s{1}(.+)/i, (msg) ->
    script = msg.match[1]
    scriptArgs = msg.match[2]
    console.log "Running #{script} #{scriptArgs}"
    data = ''
    spawn = require('child_process').spawn
    proc = spawn "ruby", ["#{scriptPath}/rimubot.rb", httpUrl, msg.message.user.room, script, scriptArgs]
    me = this
    proc.stdout.on 'data', (chunk) ->
      data += chunk.toString()
    proc.stderr.on 'data', (chunk) ->
      msg.send chunk.toString()
    proc.stdout.on 'end', () ->
      msg.send data.toString()


  bot.router.post routerPost, (req, res) ->
    user = bot.brain.userForId 'broadcast'
    user.room = req.body.room
    user.type = 'groupchat'
    result = req.body.result
    bot.send user, "#{result}"
    res.end "O.o"

